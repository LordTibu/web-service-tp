name: Postman / Newman tests

on:
  push:
  pull_request:

jobs:
  newman:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:latest
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping:1})' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Wait for MongoDB to be ready
        run: |
          n=0
          until nc -z localhost 27017 || [ $n -ge 30 ]; do sleep 1; n=$((n+1)); done

      - name: Start API
        env:
          MONGODB_URI: mongodb://localhost:27017/social_media
          JWT_SECRET: testsecret
          PORT: 3000
        run: npm start &

      - name: Wait for API to be ready
        run: |
          n=0
          until curl -sSf http://localhost:3000/ || [ $n -ge 30 ]; do sleep 1; n=$((n+1)); done

      - name: Run Newman collection
        run: npx newman run newman/Test_API.postman_collection.json -e newman/Test_API.postman_environment.json --delay-request 250 -r cli,junit --reporter-junit-export newman-results.xml

      - name: Upload Newman JUnit report
        uses: actions/upload-artifact@v4
        with:
          name: newman-results
          path: newman-results.xml
